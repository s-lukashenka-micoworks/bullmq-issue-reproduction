"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.repairStalledKey = void 0;
const content = `--[[
   Try to repair stalled key type.
   Input:
      KEYS[1]  stalled key
]]
local rcall = redis.call
-- Includes
--[[
  Function to loop in batches.
  Just a bit of warning, some commands as ZREM
  could receive a maximum of 7000 parameters per call.
]]
local function batches(n, batchSize)
  local i = 0
  return function()
    local from = i * batchSize + 1
    i = i + 1
    if (from <= n) then
      local to = math.min(from + batchSize - 1, n)
      return from, to
    end
  end
end
local stalledKeyType = rcall("TYPE", KEYS[1])
if stalledKeyType["ok"] == "zset" then
    local stalling = rcall('ZREVRANGEBYSCORE', KEYS[1], "inf", "-inf")
    if (#stalling > 0) then
        rcall('DEL', KEYS[1])
        for from, to in batches(#stalling, 7000) do
            rcall('SADD', KEYS[1], unpack(stalling, from, to))
        end
    end
end
`;
exports.repairStalledKey = {
    name: 'repairStalledKey',
    content,
    keys: 1,
};
//# sourceMappingURL=repairStalledKey-1.js.map