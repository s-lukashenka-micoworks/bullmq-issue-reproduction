--[[
   Try to repair stalled key type.
   
   Input:
      KEYS[1]  stalled key
]]
local rcall = redis.call

-- Includes
--- @include "<base>/includes/batches"

local stalledKeyType = rcall("TYPE", KEYS[1])
if stalledKeyType["ok"] == "zset" then
    local stalling = rcall('ZREVRANGEBYSCORE', KEYS[1], "inf", "-inf")

    if (#stalling > 0) then
        rcall('DEL', KEYS[1])

        for from, to in batches(#stalling, 7000) do
            rcall('SADD', KEYS[1], unpack(stalling, from, to))
        end
    end
end
