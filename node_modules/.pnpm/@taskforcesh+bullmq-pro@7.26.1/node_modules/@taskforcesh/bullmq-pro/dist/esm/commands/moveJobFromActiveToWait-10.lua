--[[
  Function to move job from active state to wait.
  Input:
    KEYS[1]  active key
    KEYS[2]  wait key
    KEYS[3]  stalled key
    KEYS[4]  job lock key
    KEYS[5]  paused key
    KEYS[6]  meta key
    KEYS[7]  limiter key
    KEYS[8]  prioritized key
    KEYS[9]  marker key
    KEYS[10] event key

    ARGV[1] job id
    ARGV[2] lock token
    ARGV[3] keys prefix
    ARGV[4] max concurrency group
    ARGV[5] job id key

]]
local rcall = redis.call

-- Includes
--- @include "<base>/includes/addJobInTargetList"
--- @include "<base>/includes/getOrSetMaxEvents"
--- @include "<base>/includes/getTargetQueueList"
--- @include "<base>/includes/pushBackJobWithPriority"
--- @include "includes/addToGroup"
--- @include "includes/decreaseGroupConcurrency"

local jobId = ARGV[1]
local token = ARGV[2]
local lockKey = KEYS[4]

local lockToken = rcall("GET", lockKey)
local pttl = rcall("PTTL", KEYS[7])
if lockToken == token then
  local metaKey = KEYS[6]
  local removed = rcall("LREM", KEYS[1], 1, jobId)
  if removed > 0 then
    local target, isPausedOrMaxed = getTargetQueueList(KEYS[6], KEYS[1], KEYS[2], KEYS[5])

    rcall("SREM", KEYS[3], jobId)
    local jobAttributes = rcall("HMGET", ARGV[5], "priority", "gid")
    local priority = tonumber(jobAttributes[1]) or 0

    if jobAttributes[2] then
      -- we assume 999999 as inf concurrency.
      decreaseGroupConcurrency(ARGV[3], KEYS[9], isPausedOrMaxed, jobAttributes[2], tonumber(ARGV[4] or 999999))

      -- lifo true as we want to try to push back the job in the head of the group list
      addToGroup(true, ARGV[3], jobAttributes[2], jobId, KEYS[9], priority,
        isPausedOrMaxed, true)
    elseif priority == 0 then
      addJobInTargetList(target, KEYS[9], "RPUSH", isPausedOrMaxed, jobId)
    else
      pushBackJobWithPriority(KEYS[8], priority, jobId)
    end

    rcall("DEL", lockKey)

    local maxEvents = getOrSetMaxEvents(metaKey)

    -- Emit waiting event
    rcall("XADD", KEYS[10], "MAXLEN", "~", maxEvents, "*", "event", "waiting", "jobId", jobId)
  end
end

return pttl
